# Audit RLS - 12/11/2025

## Sources
- `mcp.supabase.list_tables` (12/11/2025 18:00 UTC) pour l’état `rls_enabled` exposé par Supabase.
- `mcp.supabase.execute_sql` (voir query join `pg_class`/`pg_policies`) pour compter les policies par table.
- Directive RLS Supabase : https://supabase.com/docs/guides/database/postgres/row-level-security (consultée via MCP Context7).

## Synthèse globale
- ✅ Toutes les tables métier dans `public` ont `rls_enabled = true` et au moins une policy. Les tables critiques (`brand_category_mappings`, `clients`, `import_batches`, `profiles`, etc.) exposent 3–4 policies (select + insert/update/delete) alignées avec CLAUDE.md.
- ⚠️ Tables d’ingestion (`*_import_rows`) et historiques (`brand_mapping_history`, `cir_*_history`) n’ont qu’1–3 policies : elles autorisent l’ingestion via `service_role`, mais la couverture insert/update/delete devra être revérifiée lors de `P0.4.2`.
- ℹ️ Tables systèmes Supabase (`auth.oauth_*`, `realtime.messages_*`, `supabase_migrations.*`, `vault.secrets`) apparaissent sans RLS. Elles ne sont jamais exposées via l’API publique ; aucun appel direct depuis le frontend n’a été détecté. À surveiller uniquement si des vues ou RPC publiques y accèdent (non observé).

## Détails par schéma
### public
| Table | RLS | Policies | Commentaire |
| --- | --- | --- | --- |
| brand_category_mappings | ✅ | 4 | CRUD complet, dépend de `auth.uid()`/`created_by`.
| brand_mapping_history | ✅ | 3 | Lecture/insert restreints au `service_role` ; vérifier absence de delete.
| brand_mapping_import_rows | ✅ | 1 | Flux import ; seul `service_role` peut écrire, aucun SELECT anon.
| cir_classification_history | ✅ | 2 | Append-only.
| cir_classification_import_rows | ✅ | 1 | Ingestion temporaire.
| cir_classifications | ✅ | 4 | Policies symétriques clients/admin.
| cir_segment_history | ✅ | 2 | Append-only.
| cir_segment_links | ✅ | 2 | Relations segments-clients.
| cir_segments | ✅ | 2 | Policies read/write restreintes.
| clients | ✅ | 4 | Couverture complète utilisateur/admin.
| groups | ✅ | 4 | Idem clients.
| import_batches | ✅ | 4 | Contrôle par `created_by` + `service_role`.
| mapping_templates | ✅ | 4 | Règles alignées sur le rôle admin.
| prices | ✅ | 3 | Vérifier policy delete lors de `fix_rls`.
| profiles | ✅ | 4 | Contrôle `auth.uid()` standard.

### autres schémas
- `auth`: RLS activée partout sauf `oauth_*`. Tables OAuth sont en accès `service_role` via Supabase Auth et ne sortent pas sur l’API publique.
- `realtime`: Tables `messages_*`, `subscription`, `schema_migrations` sans RLS (backend interne). Aucun mapping GraphQL/REST actif côté frontend → pas de fuite.
- `storage`: toutes les tables sont protégées (policies gérées par Supabase Storage).
- `supabase_migrations`, `vault`: pas de RLS (réservé infra). Accès limité au `service_role`/`supabase_admin`.

## Points de vigilance & suites P0.4.2
1. Écrire un script `fix_rls` pour normaliser les policies `INSERT/UPDATE/DELETE` manquantes sur `brand_mapping_history`, `*_import_rows`, `prices`. Utiliser `mcp.supabase.execute_sql` pour vérifier `permissive` vs `restrictive` avant merge.
2. Vérifier que toutes les RPC (`import-engine`, `mappingAdminTools`, etc.) se limitent aux roles attendus ; aucune d’entre elles ne doit bypasser RLS (cf. P0.2.x déjà traité).
3. Ajouter ce rapport à la checklist `AUDIT/` pour traçabilité (présent document).

Aucun impact détecté sur le site existant : les policies actuelles sont homogènes avec l’état de production.
## Mise a jour P0.4.2 - 12/11/2025 19:05 UTC
- Migration `supabase/migrations/20251112_fix_rls.sql` appliquee via `mcp.supabase.apply_migration`.
- Toutes les policies precedemment exposees au role `public` ciblent maintenant `authenticated` (voir `mcp.supabase.execute_sql`).
- Tables impactees : `brand_mapping_import_rows`, `cir_classification_history`, `cir_classification_import_rows`, `cir_segment_history`, `cir_segment_links`, `cir_segments`, `mapping_templates`.
- Requete de verification :
```sql
select tablename, policyname, roles
from pg_policies
where schemaname='public'
  and tablename in (
    'brand_mapping_import_rows',
    'cir_classification_history',
    'cir_classification_import_rows',
    'cir_segment_history',
    'cir_segment_links',
    'cir_segments',
    'mapping_templates'
  )
order by tablename, policyname;
```
- Resultat (19:05 UTC) : chaque ligne retourne `roles = {authenticated}`.

Suivi : traiter `prices` lors de P0.4.3 (ajout policy delete/update explicite) et confirmer que les Edge Functions `import-*` passent par `private.admin_guard` avant redeploiement.
## Mise a jour P0.4.3 - 12/11/2025 19:25 UTC
- Migration `supabase/migrations/20251112_prices_history_rls.sql` appliquee (split des policies `prices` + restriction `brand_mapping_history`).
- Verification `mcp.supabase.execute_sql` :
```sql
select tablename, policyname, cmd, roles
from pg_policies
where schemaname='public'
  and tablename in ('brand_mapping_history','prices')
order by tablename, cmd, policyname;
```
- Resultat : chaque table expose SELECT/INSERT/UPDATE/DELETE distincts avec `roles = {authenticated}` et predicates `private.is_admin()` / `private.can_manage_pricing()` + flag `app.writing_to_history`.
